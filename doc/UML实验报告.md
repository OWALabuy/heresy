  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
<p align="center">
  <div style="text-align: center;">
  <p style="font-size: 40px; font-weight: bold;">兼容多内核的代理线路管理系统</p>
  <p style="font-size: 40px; font-weight: bold;">Heresy</p>
  <p style="font-size: 40px; font-weight: bold;">分析与设计</p>
  </div>

  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>

  <p align="center">
  <b style="font-size: 20px;">2022 软件工程专业</b>
  </p>

  <p align="center">
  <b style="font-size: 20px;">欧阳闻奕 2022102069</b>
  </p>

  <p align="center">
  <b style="font-size: 20px;">李聪媛 2022102017</b>
  </p>

  <p align="center">
  <b style="font-size: 20px;">赵偶婷 2022102009</b>
  </p>

  <p align="center">
  <b style="font-size: 20px;">2024.10.19</b>
  </p>

  </p>
</p>

  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>

# 领域分析
## 访谈记录与分析

### 总体篇

**Q:** 平时翻墙有什么需求

**A:** 从机场订阅节点(或自己搭建节点) 选择一个节点 将节点信息写入配置文件 运行代理客户端内核 设置系统代理 开始翻墙

---

### 订阅管理

**Q:** 机场的节点信息是什么形式的? 需要怎么操作

**A:** 机场会提供一个**订阅链接** 其中的内容是一个**Base64的字符串** 将其解码后得到若干行**url格式的节点信息** 一行是一个节点

**Q:** 想要什么样的订阅管理功能

**A:** 首先需要**订阅分组** 一个订阅分组可以有一个名字和一个URL**订阅链接**(由机场提供) 然后有导入订阅功能 最后我们可以对各分组进行更新订阅 删除订阅 编辑订阅信息等操作 


### 节点管理

**Q:** 想要什么节点管理功能

**A:** 需要一个列出节点列表的功能 选中节点生成配置文件的功能(根据选中的节点进行内核的配置) 测试节点连通性和延迟的功能

**Q:** 对于单个的节点管理 你有什么想法吗

**A:** 目前我们只讨论了从机场的订阅链接获取节点信息的功能 对于自建的线路 我们是不是可以增加一个手动导入单个节点的功能 同样 也要删除单个节点的功能 不论那个节点是不是在订阅分组中 当然 手动导入的节点可以放在一个单独的分组中 这样可以自动管理 但是没有URL可供更新订阅就是了

**Q:** 附加的功能?

**A:** 有时候订阅数个机场 或节点数量过多 平时用不上这么多节点 但是又不想从订阅中删除节点 想弄出一个显示节点的筛选规则 这样只会看到我们想看的节点了

---

### 客户端与协议

**Q:** 平时使用哪些core客户端和协议

**A:** 我通常使用xray-core和Hysteria2 因为我用的机场提供trojan vmess vless hy2节点 其中前三种可以用xray解决 而hy2需要用一个特殊的客户端 xray的配置文件是json的 而hy2的配置文件是yaml的

**Q:** 客户端的代理分流情况大概怎样

**A:** xray自带分流 可以根据域名和ip来确定哪些网站走代理 哪些走直连 而hy2没有分流功能 所有的流量都会走代理 所以使用hy2的节点时 可以用xray的outbounds(出站规则)连接到hy2的监听端口 这样可以借助xray实现hy2的分流功能 (可能会有点耗电 因为两个内核都需要运行)

---

### 代理控制与软件本身

**Q:** 对于系统代理 你想要的最核心的功能是什么

**A:** 控制系统代理的开关 控制内核的运行状态

**Q:** 对于这个软件 还有什么想要的额外功能吗

**A:** 查看当前的状态 包括但不限于: 当前选中的节点 延迟值 内核状态  还有 配置核心的位置 可以在home中放一个.heresyrc作为heresy的配置文件 这个软件可以在发行时自带一些core(不过也可以自己配置...) 像V2RayN with core一样

**Q:** 你希望这个软件是命令行还是有图形界面

**A:** 反正常用的是命令行 但是也需要做图形界面给那些不习惯命令行的人使用 可以把后端和前端分离 做好那些功能 再做前端 前端可以是CUI 也可以是GUI

---

### 访谈分析

#### 一、用户需求概述
用户的主要需求是简化翻墙过程，特别是在管理机场节点和订阅的功能方面。用户希望能够方便地选择节点并将其写入配置文件，以便快速启动代理客户端。

#### 二、订阅管理
1. **订阅链接和节点信息**：
   - 用户明确了机场提供的**订阅链接**的作用，能够获取到Base64编码的节点信息，解码后形成以URL格式呈现的节点列表。

2. **功能需求**：
   - 用户希望有**订阅分组**的功能，能够对分组进行管理，包括导入、更新、删除和编辑操作。这表明用户希望能够灵活管理多个订阅源，而不只是单一的节点信息。

#### 三、节点管理
1. **功能需求**：
   - 用户提到需要展示节点列表的功能，并能够根据选中的节点生成内核配置文件。此外，测试节点的连通性和延迟也是用户关心的功能。

2. **自建线路的管理**：
   - 用户希望有手动导入单个节点的能力，以便管理自建的线路。这种灵活性能够帮助用户适应不同的使用场景。

3. **节点筛选**：
   - 对于节点数量较多的情况，用户希望能够有筛选规则，方便查看需要的节点而不必删除不常用的节点。这可以提升用户体验。

#### 四、客户端与协议
1. **使用情况**：
   - 用户常用的客户端包括xray-core和Hysteria2，表明需要支持不同的协议和内核。

2. **分流需求**：
   - 用户对xray的分流功能表示认可，但对于Hysteria2的流量处理方式提出了担忧。希望能通过xray实现对Hysteria2流量的分流控制。

#### 五、代理控制与软件本身
1. **核心功能**：
   - 用户认为控制系统代理的开关和内核的运行状态是最核心的功能。这是软件的基础要求。

2. **附加功能**：
   - 查看当前状态，包括选中节点、延迟和内核状态等信息，也是用户所需的附加功能。用户希望有一个配置文件（如`.heresyrc`），以便更好地管理软件的设置。

3. **界面选择**：
   - 虽然用户习惯命令行操作，但希望也有图形界面的支持，表明软件应具备灵活的用户界面选择。

#### 六、总结
总体来看，用户需求集中在提高翻墙的便捷性和灵活性，特别是在订阅和节点管理方面。软件的功能设计应优先考虑用户的基本需求，并提供友好的界面和灵活的配置选项，以满足不同用户的使用习惯和场景。

## 概念类与领域类图

### 概念类

从用户访谈中 可以发现一些关键词汇 订阅分组信息 节点信息 因此可以从系统中抽象出两个实体类: 订阅分组 和节点

**订阅分组** 包含: 名称 订阅URL
**节点** 包含: 名称 ip地址 端口 用户uuid 伪装网站 等等...

不同协议的节点所包含的信息也是不一样的 在后期的实现中 各协议节点可以继承node基类

### 领域类图

```mermaid
classDiagram

class Node{
    -string name
    -string ip
    -int port
    -string uuid
    -string sni
}

class Subscription{
    -string name
    -string URL
}

Node "0..n" --* "1" Subscription
```

## 业务用例图

![业务用例图](./img/业务用例图.png)

## 业务活动图

老师要求画三个喵

### 新增订阅分组

![新增订阅分组](./img/业务活动图-新增订阅分组.png)

### 导入单个节点

![导入单个节点](./img/业务活动图-导入单个节点.png)

### 选择节点

![选择节点](./img/业务活动图-选择节点.png)

# 系统需求分析

## 系统用例图

![系统用例图](./img/系统用例图.png)

## 用例说明

三个较为详细的用例说明文档 新增订阅分组 导入单个节点 选择节点

### 新增订阅分组

**用例名称:** 新增订阅分组

**用例编号:** 1-1

**用例描述:** 用户可以新增订阅分组 给定分组的名称和URL(两者都是可选的 缺省名称时使用默认名称 缺省URL时URL为空) 在数据存储中新增一个订阅分组信息

**前置条件:** 无

**基本路径:** 用户在命令行选项中选择新增 填入自定义的订阅分组名称和URL  
    新增成功 输出提示

**扩展路径(备选流程):** 若用户的输入中有缺省项 在新增时提示用户

### 导入单个节点

**用例名称:** 导入单个节点

**用例编号:** 2-5

**用例描述:** 用户可将单条节点信息导入一个订阅分组中 以在该分组中显示 并供用户选择

**前置条件:** 当前系统中有订阅分组

**基本路径:** 用户在命令行中选择导入节点 选择待导入的订阅分组 在后面写上节点的分享链接
    若用户未指定订阅分组 可将节点信息放入默认的分组

**扩展路径(备选流程):** 若用户的命令行参数不全/错误或系统无法解析用户提供的节点分享链接 输出错误提示

### 选择节点

**用例名称:** 选择节点

**用例编号:** 2-2

**用例描述:** 用户在查看节点列表后 可通过id选中节点 系统再根据当前的分流计划和选中的节点类型进行内核配置文件的生成

**前置条件:** 系统中存在节点信息

**基本路径:** 用户在命令行中指定选择节点的命令 后面加上节点的信息 在此期间 用户可以按tab键预览节点列表  
    用户输入命令后 根据此节点的类型和当前分流配置(hy2节点需要用hy2内核 且根据当前分流状态进行内核状态的管理)生成对应的配置文件 存放到内核对应的目录下

**扩展路径(备选流程):** 若用户选择的节点信息不在系统中(用户输入错误) 输出提示

## 系统流程活动图

需要4个

### 新增订阅分组

![新增订阅分组](./img/系统活动图-新增订阅分组.png)

### 导入单个节点

![导入单个节点](./img/系统活动图-导入单个节点.png)

### 选择节点

![选择节点](./img/系统活动图-选择节点.png)

### 系统代理配置

![配置系统代理](./img/系统活动图-配置系统代理.png)

## 系统需求规格说明

1. 此项目采用增量型生存期模型 在本期工程中 需要完成所有的业务逻辑并做出基于命令行的用户界面(CUI)  并将业务与操作分离 在后面的工程中 再完成基于Qt库的图形用户界面(GUI)
2. 此软件面向单用户 不需要考虑多用户情况和并发情况
3. 此软件为Linux平台设计 但考虑跨平台性 使用C++开发 可以移植到其他平台上(如Windows)
4. 软件的数据存储采用json格式 采用开源的json与C++的转换类库以实现数据文件的读取和写入(后面可能会改成sqlite 因为关系型数据库更方便管理和维护)

# 系统设计

## 系统类图

![系统类图](./img/系统类图.png)

